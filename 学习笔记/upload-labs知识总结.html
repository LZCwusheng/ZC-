<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2319"/>

<div>
<span><div><font style="font-size: 16pt;"><b>文件上传漏洞</b></font></div><div><font style="font-size: 12pt;">文件上传漏洞是由于客户端和服务器端对上传文件的类型和内容未做严格的检测，导致攻击者可以上传包含可执行脚本代码的文件，并且能够执行脚本代码。攻<b>击成功的因素：</b></font></div><div><font style="font-size: 12pt;"><b>（1）上传了含有脚本代码的文件；</b></font></div><div><font style="font-size: 12pt;"><b>（2）能够执行脚本代码。</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>上传文件的信息</b></font></div><div><font style="font-size: 12pt;">在服务器端，$_FILES用于存储有关文件的信息，相关属性如下：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">array(1) {</font></div><div><font style="font-size: 12pt;">  [&quot;arr&quot;]=&gt;                             // &lt;input&gt;的name属性值</font></div><div><font style="font-size: 12pt;">  array(5) {</font></div><div><font style="font-size: 12pt;">    [&quot;name&quot;]=&gt;                          // http请求报文中的filename值</font></div><div><font style="font-size: 12pt;">    string(9) &quot;shell.jpg&quot;</font></div><div><font style="font-size: 12pt;">    [&quot;type&quot;]=&gt;                          // http请求报文中的Content-Type</font></div><div><font style="font-size: 12pt;">    string(10) &quot;image/jpeg&quot;             </font></div><div><font style="font-size: 12pt;">    [&quot;tmp_name&quot;]=&gt;                      // 系统默认临时路径，除非修改php.ini的upload_tmp-dir</font></div><div><font style="font-size: 12pt;">    string(22) &quot;C:\Windows\phpBE20.tmp&quot;</font></div><div><font style="font-size: 12pt;">    [&quot;error&quot;]=&gt;                         // 错误代码</font></div><div><font style="font-size: 12pt;">    int(0)</font></div><div><font style="font-size: 12pt;">    [&quot;size&quot;]=&gt;                          // 文件大小</font></div><div><font style="font-size: 12pt;">    int(60)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>上传脚本的绕过技巧</b></font></div><div><font style="font-size: 12pt;">（1）<b>修改客户端的代码就可以突破限制。</b>（针对客户端检测机制）</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（2）<b>修改http头Content-Type值。</b>（服务器端检测$_FILES['arr']['type']值）</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（3）<b>后缀名改为.php3、.php4或.phtml等等。</b>能够成功执行取决于服务器端的httpd-conf配置：</font></div><div><font style="font-size: 12pt;">         <img src="upload-labs知识总结_files/Image.png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（4）<b>后缀名大小写。</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（5）<b>filename值后面添加&quot;.&quot;或&quot; &quot;(空格)，这两个字符在文件系统中会被去掉，但是在PHP代码里仍然存在。</b>因此，如果检测filename值的合法性，同时又以filename值重命名临时文件时，就可以利用             这一点绕过一些检测。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（6）<b>在filename值后面添加&quot;::$DATA&quot;。</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（7）<b>双写绕过。</b>（注意函数str_ireplace()）</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（8）$_GET和$_POST可以接收%00，而move_uploaded_file()函数在写入文件时，文件名遇到%00就会停止。因此，<b>在拼接路径时，如果能够控制某部分路径参数，就可以利用%00截断后面的路径，             从而写入到任意目录下，以及命名任意文件名。</b></font></div><div><font style="font-size: 12pt;">         <img src="upload-labs知识总结_files/Image [1].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">         注意：<b>$_FILES['filename']['name']不能存储%00，所以不能利用它截断。GET方式接收%00时，需要的条件是<span style="color: rgb(51, 51, 51); font-family: Monaco;">PHP版本&lt;5.3.4和magic_quotes_gpc为off（默认为on）。</span></b></font></div><div><font style="font-size: 16pt;"><b><br/></b></font></div><div><font style="font-size: 16pt;"><b>上传图片马的绕过技巧</b></font></div><div><font style="font-size: 12pt;">（1）<b>先上传.htaccess文件，再上传图片马。</b>.htaccess是配置文件，相当于httpd-conf，利用它可以修改当前目录以及子目录下的配置。通过修改httpd-conf的AllowOverride选项就可以启动.htaccess文件。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs知识总结_files/Image [2].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">攻击过程，.htaccess文件的内容：</font></div><div><font style="font-size: 12pt;"><img src="upload-labs知识总结_files/Image [3].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">上传.htaccess文件后，再上传含有脚本代码的图片。在访问图片时，就可以执行里面的脚本了。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（2）读写图片内容的前几个字节，验证是否为合法的图片类型。在图片马里添加相关图片类型的字节即可绕过。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（3）获取图片格式函数：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">getimagesize($img_path)                // getimagesize()读取图片信息，返回结果是一个数组， 索引 2 给出的是图像的类型，返回的是数字，其中1 = GIF，2 = JPG，3 = PNG等等。</font></div><div><font style="font-size: 12pt;">image_type_to_extension(int)           // 根据数字返回对应的图片格式后缀名</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">exif_imagetype()            //返回值为图片类型后缀名的常量。例如IMAGETYPE_GIF的值为.gif。需要PHP开启配置&quot;extension=php_exif.dll&quot;（默认关闭）</font></div></div><div><font style="font-size: 12pt;">如果利用这两个函数对上传的文件验证是否为图片格式，就直接在图片马前面添加图片固定的字节即可。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">（4）图片渲染函数：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">imagecreatefromgif($target_path);       // 渲染是对图片内容作修改，如果在里面插入了代码，那么这些代码就会被破坏。成功渲染则返回图片资源对象，失败返回false</font></div></div><div><font style="font-size: 12pt;">对二次渲染函数的绕过方法：</font></div><div><font style="font-size: 12pt;">1、如果代码插入gif图片，就直接插入在图片内容开头的固定数据块。</font></div><div><font style="font-size: 12pt;">2、如果是jpg或者png图片，就需要插入合适的数据块，并且修改数据块的数据使图片数据不出错。（可以直接利用其他人编写的脚本）</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>条件竞争和文件上传</b></font></div><div><font style="font-size: 12pt;">条件竞争是多线程同时访问同一个共享的变量或文件等数据，从而造成一些非预期的结果。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">竞争文件的示例：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">move_uploaded_file($temp_file, $upload_file)          // 移动文件</font></div><div><font style="font-size: 12pt;">unlink($upload_file)                                  // 删除文件</font></div></div><div><font style="font-size: 12pt;">先移动文件，接着判断上传文件是否合法，如果不合法再用unlink()删除文件。在这段短暂的时间内，可以同时大量发送上传文件请求和访问上传文件请求，如果有一次访问成功，那么就可以利用这一次机会执行脚本代码，写入另一个webshell。</font></div><div><font style="font-size: 12pt;">这里的多线程是大量发送上传文件请求和访问上传文件请求，共享文件是在短暂时间内存在的脚本文件，两种请求同时想要对脚本文件进行操作，形成一种竞争状态，这就是条件竞争。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">竞争变量的示例：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">// if we are here, we are ready to move the file to destination</font></div><div><font style="font-size: 12pt;">$ret = $this-&gt;move();</font></div><div><font style="font-size: 12pt;">if( $ret != 1 ){</font></div><div><font style="font-size: 12pt;">   return $this-&gt;resultUpload( $ret );    </font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// check if we need to rename the file</font></div><div><font style="font-size: 12pt;">if( $this-&gt;cls_rename_file == 1 ){</font></div><div><font style="font-size: 12pt;">  $ret = $this-&gt;renameFile();</font></div><div><font style="font-size: 12pt;">  if( $ret != 1 ){</font></div><div><font style="font-size: 12pt;">    return $this-&gt;resultUpload( $ret );    </font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">// if we are here, everything worked as planned :)</font></div><div><font style="font-size: 12pt;">return $this-&gt;resultUpload( &quot;SUCCESS&quot; );</font></div></div><div><font style="font-size: 12pt;">先移动文件，在renameFile()函数中以时间戳为基础生成新的文件名，这就造成在未生成第二个新的文件名之前，所有的请求都会同时竞争第一次生成的文件名，陷入竞争状态。</font></div><div><font style="font-size: 12pt;">这里的多线程是所有想要重命名的请求，共享变量是生成的文件名。除了第一次请求重命名成功以外，其它的请求都失败，即使如此，它们在前面代码中执行的操作仍旧完成。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>/.</b></font></div><div><font style="font-size: 12pt;"><b>move_uploaded_file()函数在移动文件时，会忽略目标路径最后的&quot; /. &quot;</b>，利用这一点可以绕过一些检测。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>$_POST</b></font></div><div><font style="font-size: 12pt;">$_POST接收文件上传表单的参数时，也可以接收一个数组。如图：</font></div><div><font style="font-size: 12pt;"><img src="upload-labs知识总结_files/Image [4].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">$_POST接收到的数组：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">array(1) {</font></div><div><font style="font-size: 12pt;">  [&quot;save_name&quot;]=&gt;   </font></div><div><font style="font-size: 12pt;">  array(2) {</font></div><div><font style="font-size: 12pt;">    [0]=&gt; </font></div><div><font style="font-size: 12pt;">    string(10) &quot;shell.php/&quot;</font></div><div><font style="font-size: 12pt;">    [3]=&gt;</font></div><div><font style="font-size: 12pt;">    string(3) &quot;png&quot;</font></div><div><font style="font-size: 12pt;">   }</font></div><div><font style="font-size: 12pt;">}   </font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>文件上传的防御</b></font></div><div><font style="font-size: 12pt;">1、客户端检测，使用js对上传图片检测，包括文件大小、文件扩展名、文件类型等</font></div><div><font style="font-size: 12pt;">2、服务端检测，对文件大小、文件路径、文件扩展名、文件类型、文件内容检测、对文件重命名。</font></div><div><font style="font-size: 12pt;">3、服务器端上传目录设置不可执行权限。</font></div></span>
</div></body></html> 