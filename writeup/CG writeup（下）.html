<html>
<head>
  <title>CG writeup（下）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2039"/>
<h1>CG writeup（下）</h1>

<div>
<span><div><span style="font-size: 36pt; font-weight: bold;">综合题</span><br/></div><div><img src="CG writeup（下）_files/Image.png" type="image/png" data-filename="Image.png" width="574"/></div><div><span style="font-size: 12pt;">这是经过加密的js代码，复制全部扔到控制台执行。结果：</span></div><div><img src="CG writeup（下）_files/Image [1].png" type="image/png" data-filename="Image.png" width="511"/></div><div><span style="font-size: 12pt;">访问 1bc29b36f623ba82aaf6724fd3b16718.php，返回：</span></div><div><img src="CG writeup（下）_files/Image [2].png" type="image/png" data-filename="Image.png" width="770"/></div><div><span style="font-size: 12pt;">脑袋即头部(header)，查看效应头：</span></div><div><img src="CG writeup（下）_files/Image [3].png" type="image/png" data-filename="Image.png" width="295"/></div><div><span style="font-size: 12pt;">意思是命令行历史记录，查看linux下记录历史执行命令(bash)的文件(.bash_history)，返回：</span></div><div><img src="CG writeup（下）_files/Image [4].png" type="image/png" data-filename="Image.png" width="748"/></div><div><span style="font-size: 12pt;">下载flagbak.zip，解压打开即可获得flag。</span></div><div><br/></div><div><span style="font-weight: bold;"><font style="font-size: 36pt;">SQL注入2</font></span></div><div><span style="font-size: 12pt;">源码：</span></div><div><img src="CG writeup（下）_files/Image [5].png" type="image/png" data-filename="Image.png" width="679"/></div><div><span style="font-size: 12pt;">思路：select查询语句有返回结果，输入的密码md5加密后等于数据库中的密码相等。</span></div><div><span style="font-size: 12pt;">payload：username=-1' union select '202cb962ac59075b964b07152d234b70'，password=123。</span></div><div><span style="font-size: 12pt;">&quot;123&quot;的md5值是&quot;202cb962ac59075b964b07152d234b70&quot;，这里的password不一定是&quot;123&quot;，可以为任意字符串，但它的md5值必须等于union select后面的字符串。</span></div><div><br/></div><div><span style="font-weight: bold;"><font style="font-size: 36pt;">密码重置2</font></span></div><div><img src="CG writeup（下）_files/Image [6].png" type="image/png" data-filename="Image.png" width="421"/></div><div><span style="font-size: 12pt;">f12，找到管理员邮箱：</span></div><div><img src="CG writeup（下）_files/Image [7].png" type="image/png" data-filename="Image.png" width="537"/></div><div><span style="font-size: 12pt;">打开submit.php页面的vi备份文件，找到源码：</span></div><div><img src="CG writeup（下）_files/Image [8].png" type="image/png" data-filename="Image.png" width="510"/></div><div><span style="font-size: 12pt;">审计代码：</span></div><div><img src="CG writeup（下）_files/Image [9].png" type="image/png" data-filename="Image.png" width="686"/></div><div><span style="font-size: 12pt;">token的长度等于10，与&quot;0&quot;的弱类型比较结果为假，同时token的值为0，经过测试：在数据库中，以&quot;0e&quot;开头的字符串的值与0相等。因此，payload：</span></div><div><img src="CG writeup（下）_files/Image [10].png" type="image/png" data-filename="Image.png" width="830"/></div><div><span style="font-weight: bold;"><font style="font-size: 36pt;">file_get_contents</font></span></div><div><img src="CG writeup（下）_files/Image [11].png" type="image/png" data-filename="Image.png" width="660"/></div><div><span style="font-size: 12pt;">GET传参，但我们不知道其它任何文件，所以可以使用data://伪协议直接读入内容，payload：</span></div><div><img src="CG writeup（下）_files/Image [12].png" type="image/png" data-filename="Image.png" width="771"/></div><div><span style="font-size: 12pt;">data://表示数据流，数据格式为text纯文本，plain意思是直接读入原文格式。</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;"><font style="font-size: 36pt;">变量覆盖</font></span></div><div><img src="CG writeup（下）_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt;">$_GET是一个数组，在foreach循环中，它的键名赋给$key，键值赋给$value。我们需要设置$name=&quot;meizijiu233&quot;，payload：name=meizijiu233。PHP处理后$_GET['name']=&quot;meizijiu233&quot;，接着在foreach循环中，$key=&quot;name&quot;，$value=&quot;meizijiu233&quot;，执行循环体语句：$name=&quot;meizijiu233&quot;，这样就成功设置$name的值，得到flag。</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;"><font style="font-size: 36pt;">综合题2</font></span></div><div><span style="font-size: 12pt;">主页面</span></div><div><img src="CG writeup（下）_files/Image [14].png" type="image/png" data-filename="Image.png" width="687"/></div><div><span style="font-size: 12pt;">（1）在页面底部有一个cms遗留文件，打开它</span></div><div><img src="CG writeup（下）_files/Image [15].png" type="image/png" data-filename="Image.png" width="454"/></div><div><br/></div><div><span style="font-size: 12pt;">这里含有一个任意文件读取漏洞，可以利用读取页面源码</span></div><div><img src="CG writeup（下）_files/Image [16].png" type="image/png" data-filename="Image.png" width="580"/></div><div><span style="font-size: 12pt;">获得源码的页面有：about.php、index.php、passencode.php、say.php、antiinject.php、antixss.php、so.php、say.php、preview.php。部分页面是从源码中得知的，也可以读取它们的源码。</span></div><div><span style="font-size: 12pt;">（2）审计代码，寻找漏洞。通读一遍代码后，目标首先锁定在so.php，这是一个负责处理搜索模块的逻辑。</span></div><div><img src="CG writeup（下）_files/Image [17].png" type="image/png" data-filename="Image.png" width="1010"/></div><div><span style="font-size: 12pt;">接下来先利用SQL注入读取数据库的数据，从sm.txt页面发现了admin表的结构，所以可以读取admin表的数据。</span></div><div><img src="CG writeup（下）_files/Image [18].png" type="image/png" data-filename="Image.png" width="650"/></div><div><span style="font-size: 12pt;">再看过滤函数antiinject()的定义，它在antiinject.php页面中。</span></div><div><img src="CG writeup（下）_files/Image [19].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt;">读取admin表的payload：=0/**/uniunionon/**/seleselectct/**/1,usernanameme,userpapassss,4/**/frfromom/**/admadminin/**/limit/**/0,1</span></div><div><img src="CG writeup（下）_files/Image [20].png" type="image/png" data-filename="Image.png" width="1012"/></div><div><br/></div><div><span style="font-size: 12pt;">（3）找到后台。先审计一下preview.php，发现它将我们在前端留言版写的内容再次打印在这个页面中。</span></div><div><img src="CG writeup（下）_files/Image [21].png" type="image/png" data-filename="Image.png" width="805"/></div><div><br/></div><div><img src="CG writeup（下）_files/Image [22].png" type="image/png" data-filename="Image.png" width="805"/></div><div><span style="font-size: 12pt;">再看看about.php，它提示的很明显了，loginxlcteam是一个敏感目录，目录下还有页面，同时由字面意思&quot;login&quot;可以知道后台登录页面就在这个目录下。</span></div><div><img src="CG writeup（下）_files/Image [23].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt;">接下来就要跳转到后台页面，我们在留言板输入[a]loginxlcteam[/a]，点击预览后，在preview.php就会出现一个链接，点击后就跳转到后台登录页面。</span></div><div><img src="CG writeup（下）_files/Image [24].png" type="image/png" data-filename="Image.png" width="629"/></div><div><br/></div><div><br/></div><div><img src="CG writeup（下）_files/Image [25].png" type="image/png" data-filename="Image.png" width="724"/></div><div><br/></div><div><img src="CG writeup（下）_files/Image [26].png" type="image/png" data-filename="Image.png" width="669"/></div><div><span style="font-size: 12pt;">我们输入第一阶段SQL注入得到的用户名和密码，就可以登录到后台了。（密码需要转换成ASCII字符，所以密码是fuckruntu ）</span></div><div><img src="CG writeup（下）_files/Image [27].png" type="image/png" data-filename="Image.png" width="721"/></div><div><span style="font-size: 12pt;">（3）利用一句话木马。这里又提示新的xlcteam.php，我们再利用about.php页面的任意文件读取漏洞获取它的源码。</span></div><div><img src="CG writeup（下）_files/Image [28].png" type="image/png" data-filename="Image.png" width="631"/></div><div><span style="font-size: 12pt;">array_walk()是一个函数，参数$e是回调函数名，是我们可以控制的。$arr是一个数组，array_walk()函数的功能是：将$arr数组的键名和值作为回调函数的参数去执行。我们发现数组仅有一个元素的值是'/.*/e'，我搜索网上关于PHP的命令执行函数，得知preg_replace()在旧版本PHP竟然是可以在正则匹配模式/e的情况下，如果匹配成功，就可以直接将第二个参数作为代码执行。本地测试一下：</span></div><div><img src="CG writeup（下）_files/Image [29].png" type="image/png" data-filename="Image.png"/></div><div><img src="CG writeup（下）_files/Image [30].png" type="image/png" data-filename="Image.png" width="755"/></div><div><span style="font-size: 12pt;">果然可以执行代码，这里就可以利用preg_replace()函数执行代码了。payload的构造不难，它提供的模式'/.*/e'几乎可以匹配任意字符串，所以我们只需要POST请求发送两个参数&quot;www&quot;和&quot;wtf&quot;即可。我们只需要寻找网站目录下的flag文件即可，所以先利用scandir()函数读取当前目录。</span></div><div><img src="CG writeup（下）_files/Image [31].png" type="image/png" data-filename="Image.png" width="546"/></div><div><span style="font-size: 12pt;">页面显示当前目录结构：</span></div><div><img src="CG writeup（下）_files/Image [32].png" type="image/png" data-filename="Image.png" width="354"/></div><div><span style="font-size: 12pt;">有乱码，设置浏览器的编码格式为unicode</span></div><div><img src="CG writeup（下）_files/Image [33].png" type="image/png" data-filename="Image.png" width="271"/></div><div><span style="font-size: 12pt;">flag就在最后一个txt文件下了，但是读取文件的时候，发现了利用include(scandir('./')[15])无法读取文件，实在不知道怎么回事。</span></div><div><img src="CG writeup（下）_files/Image [34].png" type="image/png" data-filename="Image.png" width="722"/></div><div><span style="font-size: 12pt;">我只好直接包含乱码文件名。（如果不能直接输入中文文件名，是无法读取的，可见文件名为中文确实会出现问题，切记）</span></div><div><img src="CG writeup（下）_files/Image [35].png" type="image/png" data-filename="Image.png" width="630"/></div><div><br/></div></span>
</div></body></html> 