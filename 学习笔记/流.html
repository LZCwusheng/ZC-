<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1795"/>

<div>
<span><div><font style="font-size: 16pt;"><b>流</b></font></div><div><font style="font-size: 12pt;">流是具有流式行为的资源对象。</font></div><div><font style="font-size: 12pt;">流的作用是在出发地和目的地之间传输数据。出发地和目的地可以是文件、命令行进程、网络连接、ZIP或TAR压缩文件、临时内存、标准输入或输出、或者是通过PHP流封装协议实现的任何其他资源。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>流封装协议</b></font></div><div><font style="font-size: 12pt;">流式数据的种类各异，每种类型需要独特的协议，以便读写数据。这些协议被称为流封装协议。读写文件系统中文件的方式和收发HTTP消息的方式有所不同。流封装协议的作用是使用通用的接口封装这种差异。</font></div><div><font style="font-size: 12pt;">每个流都有一个协议和一个目标。指定协议和目标的方法是使用流标识符，其格式如下：</font></div><div><font style="font-size: 12pt;">&lt;scheme&gt;://&lt;target&gt;</font></div><div><font style="font-size: 12pt;">其中，&lt;scheme&gt;是流的封装协议，&lt;target&gt;是流的数据源。</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">实例：使用HTTP流封装协议与baidu.com通信</font></div><div><font style="font-size: 12pt;">$f = file_get_contents(&quot;http://www.baidu.com&quot;);</font></div><div><font style="font-size: 12pt;">echo $f;</font></div></div><div><font style="font-size: 12pt;">注意，这并不是网页URL，file_get_contents()函数的字符串参数其实是一个流标识符。这里的http协议让PHP使用HTTP流封装协议。在这个参数中，http之后是流的目标。网页URL只是和HTTP流封装协议相像而已。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>file://流封装协议</b></font></div><div><font style="font-size: 12pt;">因为PHP默认使用的流封装协议是file://，所以读写文件系统使用的file_get_contents()、fopen()、fclose()和fwrite()函数，默认使用的流封装协议就是file://。</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$handle = fopen('/etc/hosts', 'rb');</font></div></div><div><font style="font-size: 12pt;">等价于</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$handle = fopen('file:///etc/hosts', 'rb');</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>php://流封装协议</b></font></div><div><font style="font-size: 12pt;">这个流封装协议的作用是与PHP脚本的标准输入、标准输出和标准错误文件描述符通信。我们可以使用PHP提供的文件系统函数打开、读取或写入下面的四个流：</font></div><div><font style="font-size: 12pt;"><a href="php://stdin/">php://stdin</a>      只读PHP流，其中的数据来自标准输入。</font></div><div><font style="font-size: 12pt;"><a href="php://stdout/">php://stdout</a>    这个PHP流的作用是把数据写入当前的输出缓冲区。</font></div><div><font style="font-size: 12pt;"><a href="php://memory/">php://memory</a>   从系统内存中读取数据，或者把数据写入系统内存。</font></div><div><font style="font-size: 12pt;"><a href="php://temp/">php://temp</a>     与php://memory作用类似，但没有可用内存时，PHP会把数据写入临时文件。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>其他流封装协议</b></font></div><div><font style="font-size: 12pt;">PHP还有与ZIP和TAR压缩文件、FTP服务器、数据压缩库等通信的流封装协议。PHP的fopen()、fgets()、fputs()、feof()和close()等文件系统函数能在所有支持这些函数的流封装协议中使用。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>自定义封装协议</b></font></div><div><font style="font-size: 12pt;">PHP提供了一个示例streamWrapper类，演示如何编写自定义的流封装协议。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>流上下文</b></font></div><div><font style="font-size: 12pt;">有些PHP流能接受一系列可选的参数，这些参数叫流上下文，用于定制流的行为。不同的流封装协议使用的上下文参数有所不同。流上下文使用stream_context_create()函数会创建，返回的对象可以传入大多数文件系统和流函数。</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">示例：file_get_contents()函数发送HTTP POST请求</font></div><div><font style="font-size: 12pt;">$requestBody = '{&quot;username&quot;=&quot;hello&quot;}';</font></div><div><font style="font-size: 12pt;">$context = stream_context_create(array(</font></div><div><font style="font-size: 12pt;">    'http' =&gt; array(</font></div><div><font style="font-size: 12pt;">        'method' =&gt; 'POST',</font></div><div><font style="font-size: 12pt;">        'header' =&gt; &quot;Content-Type: application/json;charset=utf-8;\r\n&quot;.&quot;Content-Length: &quot;.mb_strlen($requestBody),</font></div><div><font style="font-size: 12pt;">        'content' =&gt; $requestBody</font></div><div><font style="font-size: 12pt;">    )</font></div><div><font style="font-size: 12pt;">));</font></div><div><font style="font-size: 12pt;">$response = file_get_contents('http://localhost:8081/flag.php', false , $context);</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>流过滤器</b></font></div><div><font style="font-size: 12pt;">若想把过滤器附加到现有的流上，要使用stream_filter_append()函数。PHP内置的过滤器：</font></div><div><font style="font-size: 12pt;">（1）string.rot13    凯撒密码</font></div><div><font style="font-size: 12pt;">（2）string.toupper  大写字母</font></div><div><font style="font-size: 12pt;">（3）string.tolower   小写字母</font></div><div><font style="font-size: 12pt;">（4）string.strip_tags  去掉标签</font></div><div><font style="font-size: 12pt;">（5）convert.base64-encode  base64加密</font></div><div><font style="font-size: 12pt;">（6）convert.base64-decode  base64解密</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">示例：stream_filter_append()添加过滤器</font></div><div><font style="font-size: 12pt;">$f = fopen(&quot;flag.php&quot;,'rb');</font></div><div><font style="font-size: 12pt;">stream_filter_append($f, 'convert.base64-encode');</font></div><div><font style="font-size: 12pt;">echo fgets($f);</font></div></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">使用php://filter流封装协议把过滤器附加到流上。</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$f = fopen(&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;,'rb');</font></div><div><font style="font-size: 12pt;">echo fgets($f);</font></div></div><div><font style="font-size: 12pt;">部分文件系统函数在调用后无法附加过滤器，因此这些函数只能使用php://filter流封装协议附加流过滤器。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>自定义流过滤器</b></font></div><div><font style="font-size: 12pt;">自定义的流过滤器是个PHP类，扩展内置的php_user_filter类。这个类必须必须实现filter()、onCreate()和onClose()方法。使用stream_filter_register()函数注册自定义的流过滤器。</font></div></span>
</div></body></html> 