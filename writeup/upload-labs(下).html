<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2235"/>

<div>
<span><div><font style="font-size: 16pt;"><b>pass-11</b></font></div><div><font style="font-size: 12pt;">查看源代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$ext_arr = array('jpg','png','gif');</font></div><div><font style="font-size: 12pt;">$file_ext = substr($_FILES['upload_file']['name'],strrpos($_FILES['upload_file']['name'],&quot;.&quot;)+1);</font></div><div><font style="font-size: 12pt;">if(in_array($file_ext,$ext_arr)){</font></div><div><font style="font-size: 12pt;">    $temp_file = $_FILES['upload_file']['tmp_name'];</font></div><div><font style="font-size: 12pt;">    $img_path = $_GET['save_path'].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</font></div><div><font style="font-size: 12pt;">    ......</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">这里使用了白名单，限制比较大，但是路径的参数可控，可以使用%00截断后面的&quot;/xxxxx.jpg&quot;，前提是这种方法使用的场景必须是PHP版本&lt;5.3.4和magic_quotes_gpc为off（默认为on）。</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image.png" type="image/png" data-filename="Image.png"/></font></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 16pt;"><b>pass-12</b></font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">这道题跟pass-11方法类似，不过post数据不是在url，所以直接输入%00不会被解码，需要在hex修改。</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [1].png" type="image/png" data-filename="Image.png"/></font></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 16pt;"><b>pass-13</b></font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">任务是上传一个图片马，先看代码：</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">function getReailFileType($filename){</font></div><div><font style="font-size: 12pt;">    $file = fopen($filename, &quot;rb&quot;);</font></div><div><font style="font-size: 12pt;">    $bin = fread($file, 2); //只读2字节</font></div><div><font style="font-size: 12pt;">    fclose($file);</font></div><div><font style="font-size: 12pt;">    $strInfo = @unpack(&quot;C2chars&quot;, $bin);    </font></div><div><font style="font-size: 12pt;">    $typeCode = intval($strInfo['chars1'].$strInfo['chars2']);    </font></div><div><font style="font-size: 12pt;">    $fileType = '';    </font></div><div><font style="font-size: 12pt;">    switch($typeCode){      </font></div><div><font style="font-size: 12pt;">        case 255216:            </font></div><div><font style="font-size: 12pt;">            $fileType = 'jpg';</font></div><div><font style="font-size: 12pt;">            break;</font></div><div><font style="font-size: 12pt;">        case 13780:            </font></div><div><font style="font-size: 12pt;">            $fileType = 'png';</font></div><div><font style="font-size: 12pt;">            break;        </font></div><div><font style="font-size: 12pt;">        case 7173:            </font></div><div><font style="font-size: 12pt;">            $fileType = 'gif';</font></div><div><font style="font-size: 12pt;">            break;</font></div><div><font style="font-size: 12pt;">        default:            </font></div><div><font style="font-size: 12pt;">            $fileType = 'unknown';</font></div><div><font style="font-size: 12pt;">        }    </font></div><div><font style="font-size: 12pt;">        return $fileType;</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;">这个函数的参数是临时文件路径，只读取文件的前两个字节，因此可以在winhex中给文件头部添加图片的头两个字节。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [2].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">修改文件后缀名为.jpg后上传即可。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-14</b></font></div><div><font style="font-size: 12pt;">关键代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$info = getimagesize($filename);</font></div><div><font style="font-size: 12pt;">$ext = image_type_to_extension($info[2]);       // 这个函数根据数字返回图片类型后缀名。</font></div></div><div><font style="font-size: 12pt;">仍然是上传图片马，但这次是利用getimagesize()读取图片信息，返回结果是一个数组， 索引 2 给出的是图像的类型，返回的是数字，其中1 = GIF，2 = JPG，3 = PNG等等。PNG的图片类型是文件头部8个字节确定的，因此可以在脚本代码前面添加这8个字节。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [3].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">保存为shell.png即可上传成功。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-15</b></font></div><div><font style="font-size: 12pt;">关键代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$image_type = exif_imagetype($filename);</font></div><div><font style="font-size: 12pt;">switch ($image_type) {</font></div><div><font style="font-size: 12pt;">    case IMAGETYPE_GIF:</font></div><div><font style="font-size: 12pt;">        return &quot;gif&quot;;</font></div><div><font style="font-size: 12pt;">        break;</font></div><div><font style="font-size: 12pt;">    case IMAGETYPE_JPEG:</font></div><div><font style="font-size: 12pt;">        return &quot;jpg&quot;;</font></div><div><font style="font-size: 12pt;">        break;</font></div><div><font style="font-size: 12pt;">    case IMAGETYPE_PNG:</font></div><div><font style="font-size: 12pt;">        return &quot;png&quot;;</font></div><div><font style="font-size: 12pt;">        break;    </font></div><div><font style="font-size: 12pt;">    default:</font></div><div><font style="font-size: 12pt;">        return false;</font></div><div><font style="font-size: 12pt;">        break;</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;">任务仍然是上传图片马，但是这次图片函数有所不同。exif_imagetype()函数需要PHP开启配置&quot;extension=php_exif.dll&quot;（默认关闭）。返回值为图片类型后缀名的常量。例如IMAGETYPE_GIF的值为.gif。它比getimagesize()函数的速度更快。方法与pass-14一样。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-16</b></font></div><div><font style="font-size: 12pt;">gif部分代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">else if(($fileext == &quot;gif&quot;) &amp;&amp; ($filetype==&quot;image/gif&quot;)){</font></div><div><font style="font-size: 12pt;">   if(move_uploaded_file($tmpname,$target_path))</font></div><div><font style="font-size: 12pt;">    {</font></div><div><font style="font-size: 12pt;">        //使用上传的图片生成新的图片</font></div><div><font style="font-size: 12pt;">        $im = imagecreatefromgif($target_path);</font></div><div><font style="font-size: 12pt;">        if($im == false){</font></div><div><font style="font-size: 12pt;">            $msg = &quot;该文件不是gif格式的图片！&quot;;</font></div><div><font style="font-size: 12pt;">        }else{</font></div><div><font style="font-size: 12pt;">            //给新图片指定文件名</font></div><div><font style="font-size: 12pt;">            srand(time());</font></div><div><font style="font-size: 12pt;">            $newfilename = strval(rand()).&quot;.gif&quot;;</font></div><div><font style="font-size: 12pt;">            $newimagepath = $UPLOAD_ADDR.$newfilename;</font></div><div><font style="font-size: 12pt;">            imagegif($im,$newimagepath);</font></div><div><font style="font-size: 12pt;">            //显示二次渲染后的图片（使用用户上传图片生成的新图片）</font></div><div><font style="font-size: 12pt;">            $img_path = $UPLOAD_ADDR.$newfilename;</font></div><div><font style="font-size: 12pt;">            unlink($target_path);</font></div><div><font style="font-size: 12pt;">            $is_upload = true;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    else</font></div><div><font style="font-size: 12pt;">    {</font></div><div><font style="font-size: 12pt;">        $msg = &quot;上传失败！&quot;</font></div><div><font style="font-size: 12pt;">    }</font></div></div><div><font style="font-size: 12pt;">这道题直接上传前几道的图片马，虽然显示不是gif格式的图片，但是确实上传成功。这道题的考点其实是二次渲染，经过二次渲染后，图片数据会发生变化，因此插入的php脚本代码会被破坏。但是<span style="font-weight: bold; text-decoration: underline;">可以把代码插入到图片不变的数据部分，或者修改图片的数据使插入代码后，图片的内容正常显示。</span>上传gif图片，可以把代码插入在文件头部区域。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [4].png" type="image/png" data-filename="Image.png" width="691"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-17</b></font></div><div><font style="font-size: 12pt;">条件竞争漏洞。部分源代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">if(move_uploaded_file($temp_file, $upload_file)){</font></div><div><font style="font-size: 12pt;">    if(in_array($file_ext,$ext_arr)){</font></div><div><font style="font-size: 12pt;">            $img_path = $UPLOAD_ADDR . '/'. rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</font></div><div><font style="font-size: 12pt;">            rename($upload_file, $img_path);</font></div><div><font style="font-size: 12pt;">            unlink($upload_file);</font></div><div><font style="font-size: 12pt;">            $is_upload = true;</font></div><div><font style="font-size: 12pt;">    }else{</font></div><div><font style="font-size: 12pt;">        $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;</font></div><div><font style="font-size: 12pt;">        unlink($upload_file);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}else{</font></div><div><font style="font-size: 12pt;">    $msg = '上传失败！';</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;">执行过程是先把上传文件复制到upload目录，再进行一次白名单校验，不符合要求就删除文件。在这短暂的时间内，上传文件存在于upload目录下，如何我们发送的所有访问请求里，有一次在这段时间内成功访问，就能够执行这个脚本。利用并发访问的网站特点，同时进行上传文件和访问上传文件，就可能有一次访问成功。利用这次访问就可以执行任意代码，包括在当前目录下创建webshell。</font></div><div><font style="font-size: 12pt;">上传的脚本代码</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [5].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">burpsuite多线程上传文件</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [6].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">循环执行访问页面的脚本</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [7].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">攻击成功</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [8].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-18</b></font></div><div><font style="font-size: 12pt;">任务是上传图片，部分源代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">// if we are here, we are ready to move the file to destination</font></div><div><font style="font-size: 12pt;">$ret = $this-&gt;move();</font></div><div><font style="font-size: 12pt;">if( $ret != 1 ){</font></div><div><font style="font-size: 12pt;">   return $this-&gt;resultUpload( $ret );    </font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// check if we need to rename the file</font></div><div><font style="font-size: 12pt;">if( $this-&gt;cls_rename_file == 1 ){</font></div><div><font style="font-size: 12pt;">  $ret = $this-&gt;renameFile();</font></div><div><font style="font-size: 12pt;">  if( $ret != 1 ){</font></div><div><font style="font-size: 12pt;">    return $this-&gt;resultUpload( $ret );    </font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">// if we are here, everything worked as planned :)</font></div><div><font style="font-size: 12pt;">return $this-&gt;resultUpload( &quot;SUCCESS&quot; );</font></div></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">上传的图片经过前面一系列的检测后，来到了这两步--移动文件和重命名文件。这题漏洞利用仍然是条件竞争，利用burpsuite的instruder短时间内发送大量的上传图片马请求，就能在上传目录下生成未重命名的图片马。原因解释如下：</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">（1）发送的所有请求都会在上传目录生成原名的图片马，所以会出现同名图片马，但是move_upload_file()函数不会报错，而是用新的图1片马覆盖旧的图片马，造成刷新图片马的效果，这就导致在我们发送请求的这段时间内，原名图片一直存在上传目录下。</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">（2）重命名函数是以时间戳为基础来进行重命名，这就导致在短时间内新的文件名是一样的，因此每一次执行rename()函数时，传入的两个参数是一样的，所以除了第一次rename()函数重命名成功以外，剩下的rename()函数都失败。</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">（3）但是第一步的move()函数仍旧不断刷新文件，除非刚好卡在每段时间内的第一次rename()之后结束发送请求（当然这几率很小）。最终导致的结果是：结束发送请求后，原名图片马存在上传目录下。</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">测试：</font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [9].png" type="image/png" data-filename="Image.png" width="752"/></font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [10].png" type="image/png" data-filename="Image.png"/></font></span></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [11].png" type="image/png" data-filename="Image.png" width="681"/></font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [12].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [13].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 16pt;"><b>pass-19</b></font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">源代码：</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$deny_ext = array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;pht&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;);</font></div><div><font style="font-size: 12pt;">$file_name = $_POST['save_name'];</font></div><div><font style="font-size: 12pt;">$file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">if(!in_array($file_ext,$deny_ext)) {</font></div><div><font style="font-size: 12pt;">    $img_path = $UPLOAD_ADDR . '/' .$file_name;</font></div><div><font style="font-size: 12pt;">    if (move_uploaded_file($_FILES['upload_file']['tmp_name'], $img_path)) {</font></div><div><font style="font-size: 12pt;">        $is_upload = true;</font></div><div><font style="font-size: 12pt;">    }else{</font></div><div><font style="font-size: 12pt;">        $msg = '上传失败！';</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}else{</font></div><div><font style="font-size: 12pt;">    $msg = '禁止保存为该类型文件！';</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;"><span style="color: rgb(51, 51, 51); font-family: Monaco;">任务是上传一个webshell，先截取</span><span style="color: rgb(51, 51, 51); font-family: Monaco;">$_POST['save_name']的后缀名，接着对它进行黑名单校对，再将它与根目录路径拼接成目标路径，再移动文件。</span></font></div><div><font style="font-size: 12pt;"><span style="color: rgb(51, 51, 51); font-family: Monaco;">这里因为是用$_POST接收文件名，所以可以使用%00截断。但是考点不是在这个，而是move_</span><span style="color: rgb(51, 51, 51); font-family: Monaco;">uploaded_file()函数移动文件时，它会忽略文件名后面的&quot; /. &quot;，所以这里利用这点可以使pathinfo()函数截取到的后缀名为空，以此绕过黑名单。</span></font></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [14].png" type="image/png" data-filename="Image.png"/></font></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 16pt;"><b>pass-20</b></font></span></div><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><font style="font-size: 12pt;">源代码：</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$allow_type = array('image/jpeg','image/png','image/gif');</font></div><div><font style="font-size: 12pt;">if(!in_array($_FILES['upload_file']['type'],$allow_type)){</font></div><div><font style="font-size: 12pt;">    $msg = &quot;禁止上传该类型文件!&quot;;</font></div><div><font style="font-size: 12pt;">}else{</font></div><div><font style="font-size: 12pt;">    //检查文件名</font></div><div><font style="font-size: 12pt;">    $file = empty($_POST['save_name']) ? $_FILES['upload_file']['name'] : $_POST['save_name'];</font></div><div><font style="font-size: 12pt;">    if (!is_array($file)) {</font></div><div><font style="font-size: 12pt;">        $file = explode('.', strtolower($file));</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    $ext = end($file);</font></div><div><font style="font-size: 12pt;">    $allow_suffix = array('jpg','png','gif');</font></div><div><font style="font-size: 12pt;">    if (!in_array($ext, $allow_suffix)) {</font></div><div><font style="font-size: 12pt;">        $msg = &quot;禁止上传该后缀文件!&quot;;</font></div><div><font style="font-size: 12pt;">    }else{</font></div><div><font style="font-size: 12pt;">        $file_name = reset($file) . '.' . $file[count($file) - 1];</font></div><div><font style="font-size: 12pt;">        $temp_file = $_FILES['upload_file']['tmp_name'];</font></div><div><font style="font-size: 12pt;">        $img_path = UPLOAD_PATH . '/' .$file_name;</font></div><div><font style="font-size: 12pt;">        if (move_uploaded_file($temp_file, $img_path)) {</font></div><div><font style="font-size: 12pt;">            $msg = &quot;文件上传成功！&quot;;</font></div><div><font style="font-size: 12pt;">            $is_upload = true;</font></div><div><font style="font-size: 12pt;">        } else {</font></div><div><font style="font-size: 12pt;">            $msg = &quot;文件上传失败！&quot;;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;">我们可以控制$_POST['save_name']，并且可以把发送多个值使$file变成数组，这样就不需要explode()函数的执行了，从而随意控制数组中的元素。</font></div><div><font style="font-size: 12pt;">注意：count()函数就返回数组的元素个数，而数组的下标就是键名，上传键名&quot;0&quot;和&quot;2&quot;，数组不会自动补充中间的&quot;1&quot;键名元素。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(下)_files/Image [15].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">count($file)函数返回结果为2，而count($file)-1=1，$file[1]是不存在的，即是NULL，所以$img_path=&quot; ../shell.php/. &quot;，而move_uploaded_file()函数移动文件时，它会省略&quot; /. &quot;。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><br/></div></span>
</div></body></html> 