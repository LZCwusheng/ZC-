<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2193"/>

<div>
<span><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">$_FILES变量</span></font></div><div><span style="font-size: 12pt;">文件上传是网站的一个功能，如果一个文件上传没有经过安全检测，就可能形成上传漏洞，导致攻击者可以上传可执行脚本，即通常说的webshell。</span></div><div><span style="font-size: 12pt;">PHP接收前端上传的文件时，利用全局变量$_FILES存储一些文件信息。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">//form表单：</font></div><div><font style="font-size: 12pt;">&lt;form action=&quot;&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</font></div><div><font style="font-size: 12pt;">     &lt;input type=&quot;file&quot; name=&quot;uploaded&quot;&gt;</font></div><div><font style="font-size: 12pt;">     &lt;input type=&quot;submit&quot; name=&quot;upload&quot; value='submit'&gt;</font></div><div><font style="font-size: 12pt;">&lt;/form&gt;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">//PHP端：</font></div><div><font style="font-size: 12pt;">var_dump($_FILES);</font></div></div><div><span style="font-size: 12pt;">结果：</span></div><div><span style="font-size: 12pt;"><img src="从DVWA入门上传漏洞_files/Image.png" type="image/png" data-filename="Image.png" width="307"/></span></div><div><span style="font-size: 12pt;">$_FILES数组存储了一个元素，这个元素是一个关联数组，数组名为&quot;uploaded&quot;，其中有5个键值对：</span></div><div><span style="font-size: 12pt;">name             文件名</span></div><div><span style="font-size: 12pt;">type               文件类型</span></div><div><span style="font-size: 12pt;">tmp_name     临时文件路径</span></div><div><span style="font-size: 12pt;">error              文件上传的错误代码</span></div><div><span style="font-size: 12pt;">size                文件字节大小</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">Low级别</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">&lt;?php</font></div><div><font style="font-size: 12pt;">if( isset( $_POST[ 'Upload' ] ) ) {</font></div><div><font style="font-size: 12pt;">    // 临时文件移动路径</font></div><div><font style="font-size: 12pt;">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &quot;hackable/uploads/&quot;;</font></div><div><font style="font-size: 12pt;">    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );              // basename返回文件名，可传入第二个参数，可用于去掉后缀</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 是否成功移动临时文件</font></div><div><font style="font-size: 12pt;">    if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) ) {</font></div><div><font style="font-size: 12pt;">        // 否</font></div><div><font style="font-size: 12pt;">        echo '&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    else {</font></div><div><font style="font-size: 12pt;">        // 是</font></div><div><font style="font-size: 12pt;">        echo &quot;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&quot;;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">?&gt;</font></div></div><div><span style="font-size: 12pt;">简述：首先构造移动路径，再利用move_uploaded_file()移动临时文件。</span></div><div><span style="font-size: 12pt;">LOW级别的代码完全没有对上传文件检测，以致于可以上传任何格式的文件。</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">Medium级别</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">&lt;?php</font></div><div><font style="font-size: 12pt;">if( isset( $_POST[ 'Upload' ] ) ) {</font></div><div><font style="font-size: 12pt;">    // 临时文件移动路径</font></div><div><font style="font-size: 12pt;">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &quot;hackable/uploads/&quot;;</font></div><div><font style="font-size: 12pt;">    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 获取文件信息</font></div><div><font style="font-size: 12pt;">    $uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 是否为图片类型</font></div><div><font style="font-size: 12pt;">    if( ( $uploaded_type == &quot;image/jpeg&quot; || $uploaded_type == &quot;image/png&quot; ) &amp;&amp;</font></div><div><font style="font-size: 12pt;">        ( $uploaded_size &lt; 100000 ) ) {</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        // 是否成功移动临时文件</font></div><div><font style="font-size: 12pt;">        if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) ) {</font></div><div><font style="font-size: 12pt;">            // 否</font></div><div><font style="font-size: 12pt;">            echo '&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        else {</font></div><div><font style="font-size: 12pt;">            // 是</font></div><div><font style="font-size: 12pt;">            echo &quot;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&quot;;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    else {</font></div><div><font style="font-size: 12pt;">        // 非法文件</font></div><div><font style="font-size: 12pt;">        echo '&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">?&gt;</font></div></div><div><span style="font-size: 12pt;">Medium级别比Low级别多了一项检测步骤，它检测两个信息，一是type，判断是否为图片类型jpeg或者png；二是文件大小size，判断size是否小于100000字节。</span></div><div><span style="font-size: 12pt;">这个级别虽然多了一层对文件类型type的安全检测，但type可以通过burpsuite抓包修改，从而绕过检测。</span></div><div><span style="font-size: 12pt;"><img src="从DVWA入门上传漏洞_files/Image [1].png" type="image/png" data-filename="Image.png" width="490"/></span></div><div><font style="font-size: 16pt;"><br/></font></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">High级别</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">&lt;?php</font></div><div><font style="font-size: 12pt;">if( isset( $_POST[ 'Upload' ] ) ) {</font></div><div><font style="font-size: 12pt;">    // 临时文件移动路径</font></div><div><font style="font-size: 12pt;">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &quot;hackable/uploads/&quot;;</font></div><div><font style="font-size: 12pt;">    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 获取文件信息</font></div><div><font style="font-size: 12pt;">    $uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, '.' ) + 1);</font></div><div><font style="font-size: 12pt;">    $uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_tmp  = $_FILES[ 'uploaded' ][ 'tmp_name' ];</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 判断是否图片类型</font></div><div><font style="font-size: 12pt;">    if( ( strtolower( $uploaded_ext ) == &quot;jpg&quot; || strtolower( $uploaded_ext ) == &quot;jpeg&quot; || strtolower( $uploaded_ext ) == &quot;png&quot; ) &amp;&amp;</font></div><div><font style="font-size: 12pt;">        ( $uploaded_size &lt; 100000 ) &amp;&amp;</font></div><div><font style="font-size: 12pt;">        getimagesize( $uploaded_tmp ) ) {</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        // 是否成功移动临时文件</font></div><div><font style="font-size: 12pt;">        if( !move_uploaded_file( $uploaded_tmp, $target_path ) ) {</font></div><div><font style="font-size: 12pt;">            // 否</font></div><div><font style="font-size: 12pt;">            echo '&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        else {</font></div><div><font style="font-size: 12pt;">            // 是</font></div><div><font style="font-size: 12pt;">            echo &quot;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&quot;;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    else {</font></div><div><font style="font-size: 12pt;">        // 非法文件</font></div><div><font style="font-size: 12pt;">        echo '&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">?&gt;</font></div></div><div><span style="font-size: 12pt;">High级别同样是检测文件类型，但并不是通过type属性进行，而是通过文件后缀。这里可以上传一个图片木马，再和文件包含漏洞配合，或者解析漏洞(IIS6,IIS7,Nginx,Apache)。</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">Impossible级别</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">&lt;?php</font></div><div><font style="font-size: 12pt;">if( isset( $_POST[ 'Upload' ] ) ) {</font></div><div><font style="font-size: 12pt;">    // Check Anti-CSRF token</font></div><div><font style="font-size: 12pt;">    checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 获取文件信息</font></div><div><font style="font-size: 12pt;">    $uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, '.' ) + 1);</font></div><div><font style="font-size: 12pt;">    $uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];</font></div><div><font style="font-size: 12pt;">    $uploaded_tmp  = $_FILES[ 'uploaded' ][ 'tmp_name' ];</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 临时文件移动路径</font></div><div><font style="font-size: 12pt;">    $target_path   = DVWA_WEB_PAGE_TO_ROOT . 'hackable/uploads/';</font></div><div><font style="font-size: 12pt;">    //$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</font></div><div><font style="font-size: 12pt;">    $target_file   =  md5( uniqid() . $uploaded_name ) . '.' . $uploaded_ext;</font></div><div><font style="font-size: 12pt;">    $temp_file     = ( ( ini_get( 'upload_tmp_dir' ) == '' ) ? ( sys_get_temp_dir() ) : ( ini_get( 'upload_tmp_dir' ) ) );</font></div><div><font style="font-size: 12pt;">    $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . '.' . $uploaded_ext;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    // 判断是否图片类型（检测type和后缀名）</font></div><div><font style="font-size: 12pt;">    if( ( strtolower( $uploaded_ext ) == 'jpg' || strtolower( $uploaded_ext ) == 'jpeg' || strtolower( $uploaded_ext ) == 'png' ) &amp;&amp;</font></div><div><font style="font-size: 12pt;">        ( $uploaded_size &lt; 100000 ) &amp;&amp;</font></div><div><font style="font-size: 12pt;">        ( $uploaded_type == 'image/jpeg' || $uploaded_type == 'image/png' ) &amp;&amp;</font></div><div><font style="font-size: 12pt;">        getimagesize( $uploaded_tmp ) ) {</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        // Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</font></div><div><font style="font-size: 12pt;">        if( $uploaded_type == 'image/jpeg' ) {</font></div><div><font style="font-size: 12pt;">            $img = imagecreatefromjpeg( $uploaded_tmp );</font></div><div><font style="font-size: 12pt;">            imagejpeg( $img, $temp_file, 100);</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        else {</font></div><div><font style="font-size: 12pt;">            $img = imagecreatefrompng( $uploaded_tmp );</font></div><div><font style="font-size: 12pt;">            imagepng( $img, $temp_file, 9);</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        imagedestroy( $img );</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        // 复制并重命名文件</font></div><div><font style="font-size: 12pt;">        if( rename( $temp_file, ( getcwd() . DIRECTORY_SEPARATOR . $target_path . $target_file ) ) ) {</font></div><div><font style="font-size: 12pt;">            // 成功</font></div><div><font style="font-size: 12pt;">            echo &quot;&lt;pre&gt;&lt;a href='${target_path}${target_file}'&gt;${target_file}&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;&quot;;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        else {</font></div><div><font style="font-size: 12pt;">            // 失败</font></div><div><font style="font-size: 12pt;">            echo '&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        // 删除临时文件</font></div><div><font style="font-size: 12pt;">        if( file_exists( $temp_file ) )</font></div><div><font style="font-size: 12pt;">            unlink( $temp_file );</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    else {</font></div><div><font style="font-size: 12pt;">        // 非法文件</font></div><div><font style="font-size: 12pt;">        echo '&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;';</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// Generate Anti-CSRF token</font></div><div><font style="font-size: 12pt;">generateSessionToken();</font></div><div><font style="font-size: 12pt;">?&gt;</font></div></div><div><span style="font-size: 12pt;">这个级别的防护强度已经很高了，不仅检测后缀名和type，同时重命名文件导致上传图片马也找不到脚本，还会检测文件内容，更细节的地方是手动删除临时文件，安全性非常高。</span></div></span>
</div></body></html> 