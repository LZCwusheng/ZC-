<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2201"/>

<div>
<span><div><font style="font-size: 16pt;"><b>pass-1</b></font></div><div><font style="font-size: 12pt;">上传一个PHP脚本，触发前端验证。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image.png" type="image/png" data-filename="Image.png" width="604"/></font></div><div><font style="font-size: 12pt;">方法1：去掉事件触发。删除&quot;return checkFile()&quot;。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [1].png" type="image/png" data-filename="Image.png" width="613"/></font></div><div><font style="font-size: 12pt;">重新发送即可上传成功。</font></div><div><font style="font-size: 12pt;">放法2：修改文件名为test.jpg，先绕过验证，同时抓包，再修改filename为test.php，即可绕过。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [2].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-2</b></font></div><div><font style="font-size: 12pt;">源代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">if(($_FILES['upload_file']['type'] == 'image/jpeg') || ($_FILES['upload_file']['type'] == 'image/png') || ($_FILES['upload_file']['type'] == 'image/gif')){......}</font></div></div><div><font style="font-size: 12pt;">文件类型type验证，抓包修改content-type为&quot;image/jpeg&quot;（其它类型也可）。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [3].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-3</b></font></div><div><font style="font-size: 12pt;">这题比pass-2多了过滤规则和黑名单。</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$deny_ext = array('.asp','.aspx','.php','.jsp');</font></div><div><font style="font-size: 12pt;">$file_name = trim($_FILES['upload_file']['name']);</font></div><div><font style="font-size: 12pt;">$file_name = deldot($file_name);//删除文件名末尾的点</font></div><div><font style="font-size: 12pt;">$file_ext = strrchr($file_name, '.');</font></div><div><font style="font-size: 12pt;">$file_ext = strtolower($file_ext); //转换为小写</font></div><div><font style="font-size: 12pt;">$file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA</font></div><div><font style="font-size: 12pt;">$file_ext = trim($file_ext); //收尾去空</font></div></div><div><font style="font-size: 12pt;">听说.php3、.php4和.phtml等后缀名的文件上传后可以执行，我搭建的环境无法复现成功。但是httpd-conf配置文件有一个选项可以使Apache能够解析此类后缀名脚本。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [4].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">默认应该是可以解析.phtml脚本的，但是测试失败。只有打开这一项(去掉前面的&quot;#&quot;)后，才测试成功。如果想解析.php3脚本，则需要在后面添加.php3。这种漏洞的形成原因应该是配置不当。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-4</b></font></div><div><font style="font-size: 12pt;">与pass-3相比，黑名单几乎包括所有可能执行的脚本后缀名。</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;php1&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;pHp1&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;);</font></div></div><div><font style="font-size: 12pt;">这时候可以利用.htaccess配置文件，在.htaccess文件添加内容：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">&lt;FilesMatch &quot;2.jpg&quot;&gt;</font></div><div><font style="font-size: 12pt;">SetHandler application/x-httpd-php</font></div><div><font style="font-size: 12pt;">&lt;/FilesMatch&gt;</font></div></div><div><font style="font-size: 12pt;">这些指令的作用是对&quot;2.jpg&quot;文件重新以PHP脚本解析。先上传.htaccess文件，再上传2.jpg，就成功拿到shell。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-5</b></font></div><div><font style="font-size: 12pt;">这道题pass-4与相比，禁止上传&quot;.htaccess&quot;，但是缺少了后缀名变小写的规则。因此可以把脚本文件后缀名改成大写形式，从而上传成功。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [5].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 16pt;"><b><br/></b></font></div><div><font style="font-size: 16pt;"><b>pass-6</b></font></div><div><font style="font-size: 12pt;">这道题的显示源码是有问题，显示代码码的页面和执行代码的页面有差别。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [6].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [7].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">index.php前面还缺少一句去掉空白的代码。</font></div><div><font style="font-size: 12pt;">这道题与pass-4相比，禁止上传&quot;.htaccess&quot;文件，但是缺少了去掉左右空白字符的规则。因此可以把在脚本后缀名添加空白(%20)，一般文件名后面有空白会被文件系统自动去掉，所以需要使用burpsuite使用修改。<br/></font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [8].png" type="image/png" data-filename="Image.png" width="513"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-7</b></font></div><div><font style="font-size: 12pt;">这道题与pass-4相比，禁止上传&quot;.htaccess&quot;文件，但是缺少了去掉尾部&quot; . &quot;的规则。因此可以把在脚本后缀名添加&quot; . &quot;绕过。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [9].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;">这题与pass-6的原因一致，都是利用系统对文件的命名规则，即末尾不允许有空格和小数点。因为在代码层中，空格和小数点仍保留，所以才能绕过代码层的检测。然而，在写入文件时，空格和小数点被系统去掉，导致生成了合法的脚本文件名。</font></div><div><font style="font-size: 16pt;"><b><br/></b></font></div><div><font style="font-size: 16pt;"><b>pass-8</b></font></div><div><font style="font-size: 12pt;">这道题与pass-4相比，禁止上传&quot;.htaccess&quot;文件，但是缺少了去掉尾部&quot; ::$DATA &quot;的规则。因此可以把在脚本后缀名添加&quot; ::$DATA &quot;绕过。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [10].png" type="image/png" data-filename="Image.png" width="518"/></font></div><div><font style="font-size: 12pt;">原因不详，网上说法是PHP在windows系统写入数据流时，如果文件名为&quot;文件名+::$DATA&quot;时，就会把$DATA之后的数据当作文件流处理，不会检测后缀名，且保持&quot;::$DATA&quot;之前的文件名。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-9</b></font></div><div><font style="font-size: 12pt;">综合题，代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);</font></div><div><font style="font-size: 12pt;">$file_name = trim($_FILES['upload_file']['name']);</font></div><div><font style="font-size: 12pt;">$file_name = deldot($file_name);//删除文件名末尾的点</font></div><div><font style="font-size: 12pt;">$file_ext = strrchr($file_name, '.');</font></div><div><font style="font-size: 12pt;">$file_ext = strtolower($file_ext); //转换为小写</font></div><div><font style="font-size: 12pt;">$file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA</font></div><div><font style="font-size: 12pt;">$file_ext = trim($file_ext); //首尾去空</font></div></div><div><font style="font-size: 12pt;">逻辑漏洞，后缀名添加&quot; . &quot;+&quot; &quot;+&quot; . &quot;即可绕过，首先删除最后一个小点，接着空格被截取，最后空格再被去掉，所以最后$file_ext=&quot;&quot;。在写入文件时，同样由于系统会去掉末尾的空格和小点，使得后缀名多余的&quot; . . &quot;被去掉，生成合法脚本。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 16pt;"><b>pass-10</b></font></div><div><font style="font-size: 12pt;">代码：</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">$deny_ext = array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;);</font></div><div><font style="font-size: 12pt;">$file_name = trim($_FILES['upload_file']['name']);</font></div><div><font style="font-size: 12pt;">$file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</font></div></div><div><font style="font-size: 12pt;">如果文件名含有黑名单的字符串，就会被设为空。可以双写绕过。</font></div><div><font style="font-size: 12pt;"><img src="upload-labs(上)_files/Image [11].png" type="image/png" data-filename="Image.png"/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><br/></div></span>
</div></body></html> 